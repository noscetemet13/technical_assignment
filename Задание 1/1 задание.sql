-- DDL
--
--Создала тип gender, чтобы было удобнее вводить в таблицу пол сотрудника
CREATE TYPE GENDER AS ENUM('M', 'F');
--Таблица работников
CREATE TABLE employees (
    emp_no INT PRIMARY KEY,
    birth_date DATE NOT NULL,
    full_name VARCHAR(200) NOT NULL,
    gender GENDER NOT NULL ,
    hire_date DATE NOT NULL);
--Таблица зарплат
CREATE TABLE salaries (
    emp_no INT NOT NULL,
    salary INT  NOT NULL,
    from_date DATE NOT NULL,
    to_date DATE NOT NULL,
    PRIMARY KEY (emp_no, from_date),
    FOREIGN KEY (emp_no) REFERENCES employees);
--Таблица должностей
CREATE TABLE titles (
    emp_no INT NOT NULL ,
    title VARCHAR(50) NOT NULL,
    from_date DATE NOT NULL,
    to_date DATE NOT NULL,
    PRIMARY KEY (emp_no, title, from_date),
    FOREIGN KEY (emp_no) REFERENCES employees);
--Таблица отделов
CREATE TABLE departments (
    dept_no CHAR(4) PRIMARY KEY,
    dept_name VARCHAR(40) NOT NULL);
--Связывающая таблица для сотрудников и их отделов
CREATE TABLE dept_manager (
    dept_no CHAR(4) NOT NULL,
    emp_no INT NOT NULL,
    from_date DATE NOT NULL,
    to_date DATE NOT NULL,
    PRIMARY KEY (dept_no, emp_no),
    FOREIGN KEY (dept_no) REFERENCES departments,
    FOREIGN KEY (emp_no) REFERENCES employees);
--Связывающая таблица для сотрудников и их отделов(2)
CREATE TABLE dept_emp (
    emp_no INT NOT NULL,
    dept_no CHAR(4) NOT NULL,
    from_date DATE NOT NULL,
    to_date DATE NOT NULL,
    PRIMARY KEY (emp_no, dept_no),
    FOREIGN KEY (emp_no) REFERENCES employees,
    FOREIGN KEY (dept_no) REFERENCES departments);

--DML
--INSERT запросы
--отдел снабжения
INSERT INTO departments values('1','Purchasing');
--отдел логистики
INSERT INTO departments values('2','Logistics');
--отдел разработки
INSERT INTO departments values('3','Development');
--отдел HR
INSERT INTO departments values('4','HR');
--отдел финансов
INSERT INTO departments values('5','Finance');

--Ввод данных в таблицу работников
INSERT INTO employees values(1,'1999-03-25','Давид Манукян','M','2021-03-22'),
(2,'1998-04-02','Николай Рихтер','M','2019-03-26'),
(3,'1997-12-13','Максат Абылов','M','2019-09-19'),
(4,'1994-06-17','Кристина Романова','F','2018-11-02'),
(5,'1992-07-25','Даяна Арманова','F','2018-04-13'),
(6,'1990-09-01','Мария Иванова','F','2017-12-28'),
(7,'1999-10-21','Давид Муратов','M','2019-01-15'),
(8,'2000-12-17','Ернар Хасен','M','2021-05-31'),
(9,'2000-01-20','Ернар Еркин','M','2020-09-10'),
(10,'2001-03-13','Амина Жолдаскалиева','F','2021-12-24'),

(11,'2002-08-08','Давид Степанов','M','2022-07-17'),
(12,'1987-05-20','Иван Дубинин','M','2016-02-29'),
(13,'1985-02-28','Разия Маратова','F','2015-10-05'),
(14,'1989-08-02','Раяна Ким','F','2016-09-24'),
(15,'2001-06-30','Камиля Рахманова','F','2021-05-20'),
(16,'1999-11-12','Нуртай Оразгали','M','2019-05-22'),
(17,'1988-03-15','Амелия Степанова','F','2016-11-20'),
(18,'1998-07-18','Георгий Пономарев','M','2019-09-16'),
(19,'1995-02-26','Денис Астафьев','M','2019-10-05'),
(20,'1996-10-16','Руслан Кайратов','M','2019-02-09'),

(21,'2000-04-11','Богдан Шинкарев','M','2020-11-30'),
(22,'2002-12-05','Давид Микеланджело','M','2022-11-25'),
(23,'1995-08-09','Алибек Таиров','M','2017-12-28'),
(24,'2001-05-03','Фатима Ерболатова','F','2021-08-10'),
(25,'1999-11-11','Софья Иванова','F','2019-05-03'),
(26,'1989-12-21','Мирон Пугачев','M','2017-04-01'),
(27,'1982-07-01','Максат Амиров','M','2016-06-22'),
(28,'2001-10-07','Марат Нурбеков','M','2020-03-08'),
(29,'1984-05-14','Николь Афанасьева','F','2015-07-24'),
(30,'1997-07-18','Жанат Султанова','F','2017-10-26'),

(31,'1990-09-22','Рахат Махамбетов','M','2017-10-26'),
(32,'2000-04-29','Раиля Пак','F','2021-12-03'),
(33,'1990-11-30','Карина Маркова','F','2018-06-30'),
(34,'2001-12-31','Арай Жанболатова','F','2022-04-24'),
(35,'1989-01-01','Егор Кузнецов','M','2017-06-03'),
(36,'1983-01-25','Максим Михайлов','M','2016-09-28'),
(37,'1995-04-28','Аят Назаров','M','2019-10-30'),
(38,'1985-07-23','Хасен Хасанов','M','2015-12-19'),
(39,'1997-03-05','Арсен Хадятулло','M','2018-07-11'),
(40,'2000-02-06','Жибек Мадиева','F','2021-04-08'),

(41,'2000-10-10','Аят Маутханов','M','2022-09-11'),
(42,'1994-08-02','Алина Ли','F','2015-07-11'),
(43,'1995-12-21','Константин Ким','M','2019-08-06'),
(44,'1986-08-04','Милана Сергеева','F','2015-02-01'),
(45,'1998-06-17','Иван Смирнов','M','2018-02-02'),
(46,'2001-05-27','Жанат Кабыл','M','2021-02-09'),
(47,'1999-09-18','Ерболат Арманов','M','2020-02-21'),
(48,'1983-09-04','Марк Попов','M','2015-08-21'),
(49,'1991-07-15','Жайна Куанышбаева','F','2018-05-30'),
(50,'1993-02-01','Анастасия Борисова','F','2019-09-10');

--Ввод данных в таблицу связывающую(1)
INSERT INTO dept_emp values(1,'1','2021-03-22','2023-04-09'),
(2,'1','2019-03-26','2023-04-09'),
(3,'1','2019-09-19','2023-04-09'),
(4,'1','2018-11-02','2023-04-09'),
(5,'1','2018-04-13','2023-04-09'),
(6,'1','2017-12-28','2023-04-09'),
(7,'1','2019-01-15','2023-04-09'),
(8,'1','2021-05-31','2023-04-09'),
(9,'1','2020-09-10','2023-04-09'),
(10,'1','2021-12-24','2023-04-09'),

(11,'2','2022-07-17','2023-04-09'),
(12,'2','2016-02-29','2023-04-09'),
(13,'2','2015-10-05','2023-04-09'),
(14,'2','2016-09-24','2023-04-09'),
(15,'2','2021-05-20','2023-04-09'),
(16,'2','2019-05-22','2023-04-09'),
(17,'2','2016-11-20','2023-04-09'),
(18,'2','2019-09-16','2023-04-09'),
(19,'2','2019-10-05','2023-04-09'),
(20,'2','2019-02-09','2023-04-09'),

(21,'3','2020-11-30','2023-04-09'),
(22,'3','2022-11-25','2023-04-09'),
(23,'3','2017-12-28','2023-04-09'),
(24,'3','2021-08-10','2023-04-09'),
(25,'3','2019-05-03','2023-04-09'),
(26,'3','2017-04-01','2023-04-09'),
(27,'3','2016-06-22','2023-04-09'),
(28,'3','2020-03-08','2023-04-09'),
(29,'3','2015-07-24','2023-04-09'),
(30,'3','2017-10-26','2023-04-09'),

(31,'4','2017-10-26','2023-04-09'),
(32,'4','2021-12-03','2023-04-09'),
(33,'4','2018-06-30','2023-04-09'),
(34,'4','2022-04-24','2023-04-09'),
(35,'4','2017-06-03','2023-04-09'),
(36,'4','2016-09-28','2023-04-09'),
(37,'4','2019-10-30','2023-04-09'),
(38,'4','2015-12-19','2023-04-09'),
(39,'4','2018-07-11','2023-04-09'),
(40,'4','2021-04-08','2023-04-09'),

(41,'5','2022-09-11','2023-04-09'),
(42,'5','2015-07-11','2023-04-09'),
(43,'5','2019-08-06','2023-04-09'),
(44,'5','2015-02-01','2023-04-09'),
(45,'5','2018-02-02','2023-04-09'),
(46,'5','2021-02-09','2023-04-09'),
(47,'5','2020-02-21','2023-04-09'),
(48,'5','2015-08-21','2023-04-09'),
(49,'5','2018-05-30','2023-04-09'),
(50,'5','2019-09-10','2023-04-09');

--Ввод данных в таблицу связывающую(2)
INSERT INTO dept_manager values('1',1,'2021-03-22','2023-04-09'),
('1',2,'2019-03-26','2023-04-09'),
('1',3,'2019-09-19','2023-04-09'),
('1',4,'2018-11-02','2023-04-09'),
('1',5,'2018-04-13','2023-04-09'),
('1',6,'2017-12-28','2023-04-09'),
('1',7,'2019-01-15','2023-04-09'),
('1',8,'2021-05-31','2023-04-09'),
('1',9,'2020-09-10','2023-04-09'),
('1',10,'2021-12-24','2023-04-09'),

('2',11,'2022-07-17','2023-04-09'),
('2',12,'2016-02-29','2023-04-09'),
('2',13,'2015-10-05','2023-04-09'),
('2',14,'2016-09-24','2023-04-09'),
('2',15,'2021-05-20','2023-04-09'),
('2',16,'2019-05-22','2023-04-09'),
('2',17,'2016-11-20','2023-04-09'),
('2',18,'2019-09-16','2023-04-09'),
('2',19,'2019-10-05','2023-04-09'),
('2',20,'2019-02-09','2023-04-09'),

('3',21,'2020-11-30','2023-04-09'),
('3',22,'2022-11-25','2023-04-09'),
('3',23,'2017-12-28','2023-04-09'),
('3',24,'2021-08-10','2023-04-09'),
('3',25,'2019-05-03','2023-04-09'),
('3',26,'2017-04-01','2023-04-09'),
('3',27,'2016-06-22','2023-04-09'),
('3',28,'2020-03-08','2023-04-09'),
('3',29,'2015-07-24','2023-04-09'),
('3',30,'2017-10-26','2023-04-09'),

('4',31,'2017-10-26','2023-04-09'),
('4',32,'2021-12-03','2023-04-09'),
('4',33,'2018-06-30','2023-04-09'),
('4',34,'2022-04-24','2023-04-09'),
('4',35,'2017-06-03','2023-04-09'),
('4',36,'2016-09-28','2023-04-09'),
('4',37,'2019-10-30','2023-04-09'),
('4',38,'2015-12-19','2023-04-09'),
('4',39,'2018-07-11','2023-04-09'),
('4',40,'2021-04-08','2023-04-09'),

('5',41,'2022-09-11','2023-04-09'),
('5',42,'2015-07-11','2023-04-09'),
('5',43,'2019-08-06','2023-04-09'),
('5',44,'2015-02-01','2023-04-09'),
('5',45,'2018-02-02','2023-04-09'),
('5',46,'2021-02-09','2023-04-09'),
('5',47,'2020-02-21','2023-04-09'),
('5',48,'2015-08-21','2023-04-09'),
('5',49,'2018-05-30','2023-04-09'),
('5',50,'2019-09-10','2023-04-09');

--Ввод данных в таблицу зарплат
INSERT INTO salaries values(1,87747,'2021-03-22','2023-04-09'),
(2,91326,'2019-03-26','2023-04-09'),
(3,231589,'2019-09-19','2023-04-09'),
(4,367136,'2018-11-02','2023-04-09'),
(5,239927,'2018-04-13','2023-04-09'),
(6,240926,'2017-12-28','2023-04-09'),
(7,150547,'2019-01-15','2023-04-09'),
(8,379959,'2021-05-31','2023-04-09'),
(9,348424,'2020-09-10','2023-04-09'),
(10,244645,'2021-12-24','2023-04-09'),

(11,80729,'2022-07-17','2023-04-09'),
(12,213699,'2016-02-29','2023-04-09'),
(13,327612,'2015-10-05','2023-04-09'),
(14,167397,'2016-09-24','2023-04-09'),
(15,163945,'2021-05-20','2023-04-09'),
(16,216557,'2019-05-22','2023-04-09'),
(17,302069,'2016-11-20','2023-04-09'),
(18,128693,'2019-09-16','2023-04-09'),
(19,147380,'2019-10-05','2023-04-09'),
(20,161181,'2019-02-09','2023-04-09'),

(21,81888,'2020-11-30','2023-04-09'),
(22,171332,'2022-11-25','2023-04-09'),
(23,177996,'2017-12-28','2023-04-09'),
(24,328387,'2021-08-10','2023-04-09'),
(25,207553,'2019-05-03','2023-04-09'),
(26,120780,'2017-04-01','2023-04-09'),
(27,220614,'2016-06-22','2023-04-09'),
(28,349871,'2020-03-08','2023-04-09'),
(29,220926,'2015-07-24','2023-04-09'),
(30,132675,'2017-10-26','2023-04-09'),

(31,81426,'2017-10-26','2023-04-09'),
(32,346961,'2021-12-03','2023-04-09'),
(33,302029,'2018-06-30','2023-04-09'),
(34,115600,'2022-04-24','2023-04-09'),
(35,126705,'2017-06-03','2023-04-09'),
(36,311524,'2016-09-28','2023-04-09'),
(37,380592,'2019-10-30','2023-04-09'),
(38,251932,'2015-12-19','2023-04-09'),
(39,128382,'2018-07-11','2023-04-09'),
(40,344782,'2021-04-08','2023-04-09'),

(41,95526,'2022-09-11','2023-04-09'),
(42,271312,'2015-07-11','2023-04-09'),
(43,399591,'2019-08-06','2023-04-09'),
(44,196455,'2015-02-01','2023-04-09'),
(45,359734,'2018-02-02','2023-04-09'),
(46,235543,'2021-02-09','2023-04-09'),
(47,323935,'2020-02-21','2023-04-09'),
(48,340383,'2015-08-21','2023-04-09'),
(49,344939,'2018-05-30','2023-04-09'),
(50,175000,'2019-09-10','2023-04-09');

--Ввод данных в таблицу должностей
INSERT INTO titles values(1,'Manager','2021-03-22','2023-04-09'),
(2,'Manager','2019-03-26','2023-04-09'),
(3,'Clerk','2019-09-19','2023-04-09'),
(4,'Assistant','2018-11-02','2023-04-09'),
(5,'Clerk','2018-04-13','2023-04-09'),
(6,'Buyer','2017-12-28','2023-04-09'),
(7,'Assistant','2019-01-15','2023-04-09'),
(8,'Buyer','2021-05-31','2023-04-09'),
(9,'Clerk','2020-09-10','2023-04-09'),
(10,'Assistant','2021-12-24','2023-04-09'),

(11,'Manager','2022-07-17','2023-04-09'),
(12,'Coordinator','2016-02-29','2023-04-09'),
(13,'Planner','2015-10-05','2023-04-09'),
(14,'Coordinator','2016-09-24','2023-04-09'),
(15,'Controller','2021-05-20','2023-04-09'),
(16,'Supervisor','2019-05-22','2023-04-09'),
(17,'Buyer','2016-11-20','2023-04-09'),
(18,'Clerk','2019-09-16','2023-04-09'),
(19,'Clerk','2019-10-05','2023-04-09'),
(20,'Analyst','2019-02-09','2023-04-09'),

(21,'Manager','2020-11-30','2023-04-09'),
(22,'Designer','2022-11-25','2023-04-09'),
(23,'Sysadmin','2017-12-28','2023-04-09'),
(24,'Designer','2021-08-10','2023-04-09'),
(25,'Designer','2019-05-03','2023-04-09'),
(26,'Web Developer','2017-04-01','2023-04-09'),
(27,'Programmer','2016-06-22','2023-04-09'),
(28,'Analyst','2020-03-08','2023-04-09'),
(29,'Database Administrator','2015-07-24','2023-04-09'),
(30,'Software Test Engineer','2017-10-26','2023-04-09'),

(31,'Assistant','2017-10-26','2023-04-09'),
(32,'Generalist','2021-12-03','2023-04-09'),
(33,'Manager','2018-06-30','2023-04-09'),
(34,'Analyst','2022-04-24','2023-04-09'),
(35,'Consultant','2017-06-03','2023-04-09'),
(36,'Recruiter','2016-09-28','2023-04-09'),
(37,'Administrator','2019-10-30','2023-04-09'),
(38,'Manager','2015-12-19','2023-04-09'),
(39,'Supervisor','2018-07-11','2023-04-09'),
(40,'Assistant','2021-04-08','2023-04-09'),

(41,'Auditor','2022-09-11','2023-04-09'),
(42,'Analyst','2015-07-11','2023-04-09'),
(43,'Manager','2019-08-06','2023-04-09'),
(44,'Clerk','2015-02-01','2023-04-09'),
(45,'Officer','2018-02-02','2023-04-09'),
(46,'Assistant','2021-02-09','2023-04-09'),
(47,'Director','2020-02-21','2023-04-09'),
(48,'Administrator','2015-08-21','2023-04-09'),
(49,'Coordinator','2018-05-30','2023-04-09'),
(50,'Planner','2019-09-10','2023-04-09');

--Задачи
--Задача 1: Нахождение сотрудников с именем Давид в отделе снабжения
CREATE VIEW name_filter AS
    SELECT employees.full_name, s.salary, t.title, dept_no
    FROM employees
    INNER JOIN salaries s on employees.emp_no = s.emp_no
    INNER JOIN titles t on employees.emp_no = t.emp_no
    INNER JOIN dept_emp de on employees.emp_no = de.emp_no;

SELECT full_name, salary, title
FROM name_filter
WHERE full_name LIKE 'Давид%' AND dept_no='1';

--Задача 2: Нахождение средней зарплаты по отделам
SELECT d.dept_name, AVG(salary) AS average_salary
FROM salaries
INNER JOIN employees e on e.emp_no = salaries.emp_no
INNER JOIN dept_emp de on e.emp_no = de.emp_no
INNER JOIN departments d on d.dept_no = de.dept_no
GROUP BY dept_name;

--Задача 3: Выборка "Больше ли средняя ЗП по должности, чем средняя ЗП по всем работникам"
CREATE VIEW avg_salary AS
    SELECT AVG(salary) AS average_salary FROM salaries;

CREATE VIEW avg_salary_titles AS
    SELECT title, AVG(salary) AS title_average_salary
    FROM titles
        INNER JOIN employees e on e.emp_no = titles.emp_no
        INNER JOIN salaries s on e.emp_no = s.emp_no
    GROUP BY title;

CREATE FUNCTION active(x FLOAT)
RETURNS boolean AS
    $$
        DECLARE y FLOAT;
        BEGIN
            SELECT average_salary INTO y FROM avg_salary;
            IF x > y THEN RETURN TRUE;
            ELSE RETURN FALSE;
            END IF;
        END;
    $$
LANGUAGE 'plpgsql';

SELECT ast.title, title_average_salary, CASE WHEN active(title_average_salary) = TRUE THEN 'Да' ELSE 'Нет' END AS is_greater_avg_salary
FROM titles
INNER JOIN avg_salary_titles ast on titles.title = ast.title
GROUP BY ast.title_average_salary, ast.title;

--Задача 4: Представление, в котором собраны данные по должностям
CREATE VIEW titles_dept AS
    SELECT DISTINCT t.title AS "Должность",
        array_agg(DISTINCT departments.dept_name) AS "Отделы",
        avg(s.salary)
    FROM titles t
    JOIN employees e ON t.emp_no = e.emp_no
    JOIN dept_emp ON t.emp_no = dept_emp.emp_no
    JOIN departments ON dept_emp.dept_no = departments.dept_no
    JOIN salaries s ON e.emp_no = s.emp_no
    GROUP BY t.title;


CREATE VIEW checking2 AS
    SELECT e.emp_no, e.full_name, d.dept_name, t.title
    FROM employees e
    JOIN dept_emp de on e.emp_no = de.emp_no
    JOIN departments d on d.dept_no = de.dept_no
    JOIN titles t on e.emp_no = t.emp_no
    WHERE hire_date >='2021-01-01';

CREATE VIEW final_check AS
SELECT title,
       json_object_agg(dept_name, full_name) AS workers_dept
FROM checking2
GROUP BY title;

--Увы, не удалось объединить две view в одну, выдавало разные ошибки, которые по итогу не удалось решить